<!-- Modified from Boutique Ado project -->

<!-- Guidance on how to refer to models in JS found in  https://stackoverflow.com/questions/58292527/how-to-use-djangos-models-in-javascript -->
<!-- How to get values from dropdown option pickers: https://stackoverflow.com/questions/1085801/get-selected-value-in-dropdown-list-using-javascript -->
<!-- How to get data values from dropdown option pickers: https://stackoverflow.com/questions/38519791/how-to-get-data-attribute-of-option-tag-in-javascript -->
{% if product.has_variants %}
    <script>
        // To set the default max value of the quantity selector to default selected variant stock value.
        // This has to be done programatically because the first variant might not always be avaialable.
        var e = document.getElementById("variant_picker");
        var option = e.options[e.selectedIndex];
        var stock = option.getAttribute("data-stock") - 1;
    </script>
{% else %}
    <script>
        // If a standard product, simply set max quantity to the current stock level.
        var stock = {{ product.stock_quantity|safe }} - 1;
    </script>
{% endif %}

<script type="text/javascript">

    // Disable +/- buttons outside 1-99 range
    function handleEnableDisable(itemId) {
        var currentValue = parseInt($(`#id_qty_${itemId}`).val());
        var minusDisabled = currentValue < 2;
        var plusDisabled = currentValue > stock;
        $(`#decrement-qty_${itemId}`).prop('disabled', minusDisabled);
        $(`#increment-qty_${itemId}`).prop('disabled', plusDisabled);
    }

    // Ensure proper enabling/disabling of all inputs on page load
    var allQtyInputs = $('.qty_input');
    for(var i = 0; i < allQtyInputs.length; i++){
        var itemId = $(allQtyInputs[i]).data('item_id');
        handleEnableDisable(itemId);
    }

    // Check enable/disable every time the input is changed
    $('.qty_input').change(function() {
        var itemId = $(this).data('item_id');
        handleEnableDisable(itemId);
    });

    // Increment quantity
    $('.increment-qty').click(function(e) {
       e.preventDefault();
       var closestInput = $(this).closest('.input-group').find('.qty_input')[0];
       var currentValue = parseInt($(closestInput).val());
       $(closestInput).val(currentValue + 1);
       var itemId = $(this).data('item_id');
       handleEnableDisable(itemId);
    });

    // Decrement quantity
    $('.decrement-qty').click(function(e) {
       e.preventDefault();
       var closestInput = $(this).closest('.input-group').find('.qty_input')[0];
       var currentValue = parseInt($(closestInput).val());
       $(closestInput).val(currentValue - 1);
       var itemId = $(this).data('item_id');
       handleEnableDisable(itemId);
    });
</script>